# Copyright 2023-present, Mark Delk
# SPDX-License-Identifier: Apache-2.0

name: macos

on:
  push:
    branches: ["gh-ci-macos"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    timeout-minutes: 20
    env:
      CI: true
      HOMEBREW_NO_INSTALL_CLEANUP: true
      ZIG: zig-macos-x86_64-0.12.0-dev.3496+a2df84d0f
    runs-on: macos-14

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: check for cached zig
        id: cache-zig
        uses: actions/cache@v3
        with:
          path: ${{ env.ZIG }}
          key: ${{ env.ZIG }}

      - if: ${{ steps.cache-zig.outputs.cache-hit != 'true' }}
        name: download and untar zig tarball
        run: |
          wget -nv https://ziglang.org/builds/${ZIG}.tar.xz
          tar xf ${ZIG}.tar.xz

      - name: add zig to PATH
        run: |
          echo ${PWD}/${ZIG} >> $GITHUB_PATH

      - name: zig version
        run: |
          zig version

      - name: build x86_64
        run: |
          zig build --summary all --verbose -Doptimize=ReleaseFast -Dtarget=x86_64-native -p vosk/x86_64-macos

      - name: build aarch64
        run: |
          zig build --summary all --verbose -Doptimize=ReleaseFast -Dtarget=aarch64-native -p vosk/aarch64-macos

      - uses: actions/upload-artifact@v3
        with:
          name: vosk
          path: |
            vosk
            !**/*.DS_Store
          if-no-files-found: error
          retention-days: 1
